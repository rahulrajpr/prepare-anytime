## 3. DataFrame & Dataset API

### 3.7 Aggregate Functions

#### 3.7.1 What is the difference between sum(), sumDistinct(), and approx_count_distinct()?

**Comparison Table:**

| Function                    | Purpose                    | Performance | Use Case                  |
| --------------------------- | -------------------------- | ----------- | ------------------------- |
| `sum()`                   | Sum of all values          | Fast        | Total aggregation         |
| `sumDistinct()`           | Sum of distinct values     | Medium      | Unique value sums         |
| `approx_count_distinct()` | Approximate distinct count | Very Fast   | Large dataset cardinality |

#### 3.7.2 When would you use approx_count_distinct() instead of countDistinct()?

**Usage Guidelines:**

- **`approx_count_distinct()`**: When speed matters more than exact count (large datasets)
- **`countDistinct()`**: When exact count is required (smaller datasets)

**Performance Trade-off:** `approx_count_distinct()` is 10-100x faster with 0.1-5% error margin.

#### 3.7.3 What is the difference between approx_count_distinct() and count_min_sketch()?

**Key Differences:**

- **`approx_count_distinct()`**: Returns approximate count as long integer
- **`count_min_sketch()`**: Returns serialized binary data structure for further probabilistic queries

#### 3.7.4 What does approx_count_distinct() measure vs count_min_sketch()?

**Measurement:**

- **`approx_count_distinct()`**: Direct approximate cardinality
- **`count_min_sketch()`**: Probabilistic data structure for frequency estimation

#### 3.7.5 Which function gives direct results and which returns serialized binary data?

**Output Types:**

- **Direct results**: `approx_count_distinct()`
- **Serialized binary**: `count_min_sketch()`

#### 3.7.6 What does avg() return for null values?

**Behavior:** `avg()` ignores null values in calculation (same as SQL standard).

#### 3.7.7 How do you use min() and max() functions?

**Usage:**

```python
df.select(min("salary"), max("age"))
df.groupBy("department").agg(min("salary"), max("salary"))
```

#### 3.7.8 What is stddev() and variance() used for?

**Statistical Functions:**

* **`stddev()`** : Standard deviation - measure of data dispersion
* **`variance()`** : Variance - square of standard deviation

#### 3.7.9 What does corr() function calculate (correlation)?

**Definition:** Calculates Pearson correlation coefficient between two columns (-1 to +1).

#### 3.7.10 How do you use percentile_approx() function?

**Usage:**`percentile_approx(col, percentage[, accuracy])`

**Example:**`percentile_approx("salary", 0.5)` - median salary

#### 3.7.11 What is grouping() and grouping_id() used for in GROUP BY operations?

**Purpose:** Identify aggregation levels in advanced grouping operations (ROLLUP, CUBE).

#### 3.7.12 What does grouping(col) return when a column is aggregated?

**Returns:** 1 when the column is aggregated (part of grouping), 0 when present in current grouping level.

#### 3.7.13 What does grouping(col) return when a column is present in the grouping level?

**Returns:** 0 when column is part of current grouping specification.

#### 3.7.14 What does grouping_id() return and how is it calculated?

**Returns:** Integer representing the bitmask of grouping columns.

**Calculation:** Binary mask where 1 = aggregated, 0 = present in grouping.

#### 3.7.15 What is a bitmask in the context of grouping_id()?

**Definition:** Binary representation where each bit corresponds to a grouping column's state.

**Example:** For columns (A,B,C), grouping_id 3 = 011 (A aggregated, B&C in grouping).

#### 3.7.16 When should you use grouping(col) vs grouping_id()?

**Guidelines:**

* **`grouping(col)`** : Check specific column's aggregation status
* **`grouping_id()`** : Get complete grouping level identifier

#### 3.7.17 What is the difference between GROUP BY and GROUP BY WITH ROLLUP?

**Difference:**

* **`GROUP BY`** : Single level aggregation
* **`ROLLUP`** : Hierarchical multi-level aggregations

#### 3.7.18 How does ROLLUP create hierarchical aggregations?

**Behavior:** Creates aggregations at each level of the hierarchy, from most detailed to grand total.

#### 3.7.19 How does GROUP BY WITH ROLLUP handle NULL values differently?

**Important:** ROLLUP uses NULL to indicate aggregated levels, which can conflict with actual NULL data values.

### 3.7.1 Aggregation After GroupBy - Critical Distinction

#### 3.7.1.1 Can you use select() after groupBy()? Why or why not?

**Answer:** No, `select()` cannot be used directly after `groupBy()` because `groupBy()` returns a `GroupedData` object, not a DataFrame.

#### 3.7.1.2 What object type does groupBy() return?

**Returns:**`GroupedData` object - a special intermediate object for aggregation operations.

#### 3.7.1.3 What methods are available on a GroupedData object?

**Available Methods:**

* `agg()`, `count()`, `sum()`, `avg()`, `min()`, `max()`
* `pivot()`, `rollup()`, `cube()`

#### 3.7.1.4 What is the difference between DataFrame methods and GroupedData methods?

**Critical Distinction:**

* **DataFrame methods** : `select()`, `filter()`, `withColumn()`
* **GroupedData methods** : Aggregation functions only

#### 3.7.1.5 Can you use agg() on a regular DataFrame (without groupBy)?

**Answer:** Yes, `agg()` can be used on DataFrames for global aggregations.

#### 3.7.1.6 Are agg() and select() interchangeable on a regular DataFrame?

**Answer:** No, they serve different purposes:

* `select()`: Column selection and transformation
* `agg()`: Aggregate computations

#### 3.7.1.7 What is the only way to perform aggregations after groupBy()?

**Correct Syntax:** Must use aggregation methods on GroupedData object:

**python**

```
df.groupBy("dept").agg(sum("salary"))  # Correct
df.groupBy("dept").select(sum("salary"))  # Incorrect
```

#### 3.7.1.8 Why does df.groupBy("col").select(sum("value")) fail?

**Reason:**`select()` is a DataFrame method, but `groupBy()` returns GroupedData object.

#### 3.7.1.9 What is the correct syntax for aggregation after groupBy?

**Correct Patterns:**

**python**

```
# Method 1: Using agg()
df.groupBy("department").agg(
    sum("salary").alias("total_salary"),
    avg("salary").alias("avg_salary")
)

# Method 2: Using direct aggregation methods
df.groupBy("department").sum("salary")

# Method 3: Using count()
df.groupBy("department").count()
```

### 3.7.2 ROLLUP and CUBE - Advanced Grouping

#### 3.7.2.1 What is the basic purpose of rollup() vs groupBy()?

**Purpose:**

* **`groupBy()`** : Single-level aggregation
* **`rollup()`** : Multi-level hierarchical aggregations

#### 3.7.2.2 How many aggregation levels does rollup() create?

**Levels:** n+1 levels for n grouping columns (including grand total).

#### 3.7.2.3 What is the formula for number of result rows in rollup()?

**Formula:** If n columns, produces 2^n combinations (including grand total).

**Example:** 3 columns → 2^3 = 8 combinations.

#### 3.7.2.4 What is the basic purpose of cube() vs rollup()?

**Purpose:**

* **`rollup()`** : Hierarchical aggregations (drill-down path)
* **`cube()`** : All possible combinations (cross-tabulation)

#### 3.7.2.5 How many combinations does cube() create?

**Combinations:** 2^n for n grouping columns (all possible subsets).

#### 3.7.2.6 What is the formula for number of combinations in cube() (2^n)?

**Formula:** 2^n where n = number of grouping columns.

**Example:** 3 columns → 2^3 = 8 possible combinations.

#### 3.7.2.7 Which is faster: groupBy(), rollup(), or cube()?

**Performance Order:**

1. `groupBy()` (fastest - single aggregation)
2. `rollup()` (medium - hierarchical aggregations)
3. `cube()` (slowest - all combinations)

#### 3.7.2.8 When would you use rollup() over groupBy()?

**Use Cases for ROLLUP:**

* Financial reporting (department → division → company totals)
* Organizational hierarchies
* Multi-level summary reports

#### 3.7.2.9 When would you use cube() over rollup()?

**Use Cases for CUBE:**

* Business intelligence dashboards
* Cross-tabulation analysis
* Exploring all dimension combinations

#### 3.7.2.10 How do NULL values indicate aggregation levels in rollup() and cube()?

**Indicator:** NULL values in grouping columns represent aggregated levels.

**Caution:** Can conflict with actual NULL data values.

#### 3.7.2.11 What is the difference between hierarchical relationships in rollup() vs cube()?

**Hierarchy:**

* **`rollup()`** : Fixed hierarchy (A > B > C)
* **`cube()`** : No hierarchy - all combinations equal

#### 3.7.2.12 What are typical use cases for rollup()?

**ROLLUP Use Cases:**

* Financial quarter reports (Q1 > Month > Week)
* Sales territories (Region > Country > City)
* Organizational charts (Company > Division > Department)

#### 3.7.2.13 What are typical use cases for cube()?

**CUBE Use Cases:**

* Marketing analysis (Channel × Product × Region)
* Business intelligence dashboards
* Exploratory data analysis

#### 3.7.2.14 How does grouping_id() help identify aggregation levels in rollup() and cube()?

**Identification:**`grouping_id()` provides unambiguous level identification, avoiding NULL value conflicts.

### 3.7.3 SQL Database Support for ROLLUP and CUBE

#### 3.7.3.1 Which major SQL databases support ROLLUP?

**ROLLUP Support:**

* ✅ Oracle, SQL Server, PostgreSQL, MySQL
* ✅ Spark SQL, Databricks, Trino
* ❌ SQLite (limited)

#### 3.7.3.2 Which major SQL databases support CUBE?

**CUBE Support:**

* ✅ Oracle, SQL Server, PostgreSQL
* ⚠️ MySQL (limited)
* ✅ Spark SQL, Databricks, Trino
* ❌ SQLite

#### 3.7.3.3 Does MySQL fully support ROLLUP and CUBE?

**MySQL Support:**

* ✅ ROLLUP: Full support with `WITH ROLLUP`
* ⚠️ CUBE: Not supported (must simulate with UNION)

#### 3.7.3.4 What is the MySQL syntax for ROLLUP (WITH ROLLUP)?

**MySQL Syntax:**

**sql**

```
SELECT dept, gender, SUM(salary)
FROM employees
GROUP BY dept, gender WITH ROLLUP;
```

#### 3.7.3.5 Does SQLite support ROLLUP or CUBE?

**SQLite Support:** ❌ Neither ROLLUP nor CUBE supported natively.

#### 3.7.3.6 What is the standard SQL syntax for ROLLUP and CUBE?

**Standard SQL Syntax:**

**sql**

```
-- ROLLUP
GROUP BY ROLLUP (col1, col2, col3)

-- CUBE  
GROUP BY CUBE (col1, col2, col3)
```

#### 3.7.3.7 Do SQL Server, PostgreSQL, and Oracle support both ROLLUP and CUBE?

**Support Matrix:**

| Database   | ROLLUP | CUBE |
| ---------- | ------ | ---- |
| SQL Server | ✅     | ✅   |
| PostgreSQL | ✅     | ✅   |
| Oracle     | ✅     | ✅   |
| MySQL      | ✅     | ❌   |
| SQLite     | ❌     | ❌   |

#### 3.7.3.8 Does Spark SQL support ROLLUP and CUBE in both SQL and DataFrame API?

**Spark Support:**

* ✅ SQL: `GROUP BY ROLLUP/CUBE`
* ✅ DataFrame: `rollup()`, `cube()` methods

#### 3.7.3.9 Do Trino and Databricks support ROLLUP and CUBE?

**Support:**

* ✅ Trino: Full support
* ✅ Databricks: Full support (based on Spark SQL)

#### 3.7.3.10 What additional grouping features does Spark SQL support (GROUPING SETS)?

**Advanced Features:**

* `GROUPING SETS`: Custom aggregation combinations
* Combination of ROLLUP and CUBE operations
* Fine-grained control over aggregation levels

**Example:**

**sql**

```
GROUP BY GROUPING SETS ((dept), (gender), (dept, gender), ())
```
